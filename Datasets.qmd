---
title: "Dataframes"
subtitle: "Quantitative Methodology (UPF)"
author: "Jordi Mas Elias"
institute: "<https://www.jordimas.cat/>"
footer: "Quantitative Methodology (UPF)"
logo: logo-upf.png
bibliography: references.bib
format: 
  revealjs:
    embed-resources: true
    slide-number: true
    show-slide-number: print
    theme: simple
editor: source
editor_options: 
  chunk_output_type: console
---


```{r include=FALSE}
# automatically create a bib database for R packages
knitr::write_bib(c(
  .packages(), 'bookdown', 'knitr', 'rmarkdown', 'dplyr', 'ggplot2',
  'tidyr', 'readxl', 'readr', 'tidyverse', 'pacman', 'lubridate'
), 'packages.bib')
```


## Summary

-   What is a dataframe?
-   Observations
-   Variables
-   Recoding variables
-   Scope of data

```{r echo = F, message=F, warning=F}
library(tidyverse)
library(readxl)
```


# What is a dataframe? {background-color="#e8e8e8"}

## Table

It s a generic name. It can be almost anything.

- Periodic table
- Multiplication table
- Truth table
- Chi squared table 
- Phonetic table
- ...

## Data(s)

- **Source of information (SI):** Raw empirical material.
- **Data (s/p):** Collected, processed, systematized and organized SI [@VanEvera2009].
    - Numbers, characters, symbols ... no meaning.
- **Database:** An organized collection of data stored and accessed electronically / An organized collection of data stored as multiple datasets.
- **Dataset:** A structured collection of data generally associated with a unique body of work.


## Spreadsheet

How Excel stores data in two dimensions:

![](img/excel-spreadsheet.png)


## Dataframe

A way^[Other ways are: vectors, matrixs, arrays...] to store data in R in **two dimensions**: rows and columns^[And we will normally store dataframes in a *tidy* way.]:

```{r echo = F}
read_xls("p5v2018.xls") |> 
  select(scode, country, year, polity2, xrreg:parreg)
```



## A _tidy_ dataframe

We consider that a dataframe is *tidy* if it fulfills the following requirements [@Wickham2014]:

- Each dataframe has one **unit of observation**.
- **Observations** are represented in the rows.
- **Variables** are represented in the columns.
- Each **cell** indicates a value.

## RStudio workflow

**Load packages:** Everytime you join R.

```{r echo = T, message=F, warning=F}
library(dplyr)
library(ggplot2)
library(readr)
library(stringr)
library(forcats)
```

![](img/r-packages.png){style="float:center;" width="650"}


# Observations {background-color="#e8e8e8"}

## Observing ...

:::: {.columns}

::: {.column width="40%"}
We need to decide which are the **units** of interest.
:::

::: {.column width="60%"}
![](https://2.bp.blogspot.com/-wA7H0iOgUgM/VtSymS91sfI/AAAAAAAAA1U/UEtXfoDg8j0/s1600/day_globe_75fr_125ms.gif)
:::

::::




## What is an observation?

-	**Unit of analysis:** The thing that we want to know about.
    - Determined by the hypothesis / question.
-	**Unit of observation:** Each row of a dataframe.
    - Determined by the instrument of measurement.


```{r}
gapminder::gapminder |> 
  head(8)
```



## Example: Macro level {.scrollable}

States, regions, legal systems ...

```{r}
interstate <- read_csv("data/Intra-StateWarData_v4.1.csv")
interstate |> 
  select(WarName, WarType, CcodeA, SideA, CcodeB, SideB) |> 
  head(15)
```

Intra-State War Data ([Correlates of War](https://correlatesofwar.org/data-sets/cow-war/))



## Example: Meso level

Organitzations, ethnic groups, political parties ...

```{r}
read_csv("data/rfe.csv")
```

[International Conflict Research](https://icr.ethz.ch/data/epr/){target="_blank"}

## Example: Micro level

Families, individuals, relationships ...

```{r}
read_csv("data/nig.csv") |> 
  select(1:5)
```

Autobarometer - Nigeria

## Example: Events

Bombings, contracts, terrorist attacks...

```{r}
read_csv("data/cam_list_3.0.csv") |> 
  select(-date)
```

[Coup Agency and Mechanisms Dataset](https://militarycoups.org/Codebook-v3.0.html){target="_blank"}


## Ecological fallacy

When the UA and the UO are not the same, we run the risk of having an ecological fallacy problem.

- Admissions

```{r}
uni <- tibble(faculty = rep(c("Psysics", "Politics", "Journalism"), times = 1, each = 2),
              sex = rep(c("Men", "Women"), times = 3),
              applicants = c(825,108,325,593,181,392),
              admitted = c(520, 76, 119, 203, 52, 115))
uni |> 
  group_by(sex) |> 
  summarize(applicants = sum(applicants),
            admitted = sum(admitted)) |> 
  mutate(perc_admissions = admitted / applicants * 100)
```

- Suicide

```{r}
suicide <- tibble(region = c("Isère"),
                  municipality = rep(c("Grenoble", "Le Bourg-d'Oisans", "Saint-Jean-de-Maurienne"), times = 1, each = 2),
                  religion = rep(c("Protestant", "Catholic"), times = 3),
                  population = c(8250,1080,325,593,181,392),
                  suicide = c(520, 72, 12, 20, 5, 11))
suicide |> 
  group_by(religion) |> 
  summarize(population = sum(population),
            suicide = sum(suicide)) |> 
  mutate(perc = suicide / population * 100)
```


## Ecological fallacy

Barcelona local elections: Neighbourhood level.

![](img/bcn1.png)

## Ecological fallacy

Barcelona local elections: District level.

![](img/bcn2.png)

## Ecological fallacy

Barcelona local elections: Census section level.

![](img/bcn3.png)



# Variables {background-color="#e8e8e8"}

## What is a variable?

A characteristic of the object we're studying.

- It **varies** across units.


## Types of variables (I): Nominal

- **Municipality:** Barcelona, Sant Cugat, Granollers...
- **Religion:** Muslim, Catholic, Shinto...
- **Language:** Russian, Catalan, Swedish.
- **Ideology:** Conservatism, Nationalism, Liberal...
- **Parties:** PSOE, PP, Cs, ERC...

[`stringr`](https://stringr.tidyverse.org/){target="_blank"} [@stringr2022]. En aquest apartat no ens detindrem a explicar totes les funcions del paquet. El més adequat és consultar el seu [Cheatsheet](https://www.rstudio.com/resources/cheatsheets/){target="_blank"} corresponent a la pàgina d'RStudio. Però veurem algunes funcions a continuació amb al mateix marc de dades `strings` que hem creat anteriorment:


## Types of variables (I): Ordinal

Things: Small, medium, large.
Age: Child, Young, Adult.
Education: Primary, Secondary, Tertiary.
Ideas: Agree, Neutral, Disagree.

Aid Transparency Index (ATI) 2022, [Publish What You Fund](https://www.publishwhatyoufund.org/){target="_blank"}.
[Economist Intelligence Unit](https://www.eiu.com/n/){target="_blank"} 2022.

Per manipular els factors, la millor eina que podem utilitzar és el paquet [`forcats`](https://forcats.tidyverse.org/){target="_blank"} [@forcats2022]. En aquest apartat només veurem algunes de les seves funcions, però per explorar-lo més a fons podeu consultar el seu [Cheatsheet](https://www.rstudio.com/resources/cheatsheets/){target="_blank"} corresponent a la pàgina d’RStudio. A continuació aplicarem algunes funcions al marc de dades `ords` que hem creat anteriorment. La majoria d'aquestes funcions van relacionades amb reordenar factors i són molt útils per a la visualització de gràfics.


## Types of variables (III): Interval

Zero is arbitrary.

- Year: 2004, 2005, 2008, 2010.
- Temperature (except Kelvin): 10, 25, 30.
- Ideology: Left-right measured as 0-10.
- Coordinates: Longitude and latitude.

[Polity V](https://www.systemicpeace.org/polityproject.html){target="_blank"}

```{r}
c(3, 9, 13)
```


## Types of variables (III): Ratio

Zero has meaning

- Age: 2, 5, 7, 9
- Percentages: 0%, 100%, 34%...
- Population: 13000000, 200, 33450000

[National Material Capabilities (NMC)](https://correlatesofwar.org/data-sets/national-material-capabilities){target="_blank"} dataset [@Singer1987; @Singer1972]. 

## Types of variables (IV): Summary

```{r echo = FALSE}
tribble(~Tipus, ~Característiques, ~Vector, ~Operacions, 
        "Categòrica nominal", "Categories no ordenables", "Caràcter o factor", "==, !=",
        "Categòrica ordinal", "Categories ordenables", "Factor", "==, !=, <=, <, >, >=",
        "Numèrica d'interval", "Nombres, zero sense significat", "Numèric o enter", "==, !=, <=, <, >, >=, +, -",
        "Numèrica de ràtio", "Nombres, zero amb significat", "Numèric", "==, !=, <=, <, >, >=, +, -, *, / ...") |> 
  knitr::kable()
```


# Recoding variables {background-color="#e8e8e8"}

## Boolean operators


- L'operador **AND** (`&`) retorna TRUE només si es compleixen totes les condicions.
- L'operador **OR** (`|`) retorna TRUE si es compleix una de les condicions.
- L'operador **NOT** (`!`) retorna el contrari de la condició.

```{r echo = FALSE, eval = F}
#| fig-cap: Combinacions d'operadors Booleans
#| label: fig-booleans
#| fig-column: margin
knitr::include_graphics("img/booleans.png")
```


## Summary recoding



| Destí      | Funció                                          |
|------------|-------------------------------------------------|
| Binària    | `if_else()`                                     |
| Categòrica | `case_when()`                                   |
| Ordinal    | `factor()`                                      |
| Qualsevol  | `recode()`                                      |
| Altres     | `as.numeric()`, `as.character()`, `as.Date()`, etc. |

: Variable de destí i funció que es necessita {#tbl-recoding}


## dd

{{< video https://youtu.be/6PpQS-YLWDQ >}}



# Bibliography {background-color="#e8e8e8"}




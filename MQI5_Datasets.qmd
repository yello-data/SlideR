---
title: "Dataframes"
subtitle: "Quantitative Methodology (UPF)"
author: "Jordi Mas Elias"
institute: "<https://www.jordimas.cat/>"
footer: "Quantitative Methodology (UPF)"
logo: logo-upf.png
bibliography: [references.bib, packages.bib]
format: 
  revealjs:
    embed-resources: true
    slide-number: true
    show-slide-number: print
    theme: simple
editor: source
editor_options: 
  chunk_output_type: console
---

```{r include=FALSE}
# automatically create a bib database for R packages
knitr::write_bib(c(
  .packages(), 'bookdown', 'knitr', 'rmarkdown', 'dplyr', 'ggplot2',
  'tidyr', 'readxl', 'readr', 'tidyverse', 'pacman', 'lubridate',
  'forcats', 'stringr'
), 'packages.bib')
```


## Summary

-   Warm up
-   What is a dataframe?
-   Observations
-   Variables
-   Recoding variables
-   Scope of data

```{r echo = F, message=F, warning=F}
library(tidyverse)
library(readxl)
```


# Warm up {background-color="#e8e8e8"}

## R learning curve

```{r}
rlc <- tibble(class = 1:8,
             knowledge = (1:8)^3)
class <- 2
plot(rlc$class, rlc$knowledge)
points(rlc$class[2], rlc$knowledge[2], col = "red")
```



# What is a dataframe? {background-color="#e8e8e8"}

## Table

It s a generic name. It can be almost anything.

- Periodic table
- Multiplication table
- Truth table
- Chi squared table 
- Phonetic table
- ...

## Data(s)

- **Source of information (SI):** Raw empirical material.
- **Data (s/p):** Collected, processed, systematized and organized SI [@VanEvera2009].
    - Numbers, characters, symbols ... no meaning.
- **Database:** An organized collection of data stored and accessed electronically / An organized collection of data stored as multiple datasets.
- **Dataset:** A structured collection of data generally associated with a unique body of work.


## Spreadsheet

How Excel stores data in two dimensions:

![](img/excel-spreadsheet.png)


## Dataframe

A way^[Other ways are: vectors, matrixs, arrays...] to store data in R in **two dimensions**: rows and columns^[And we will normally store dataframes in a *tidy* way.]:

```{r echo = F}
read_xls("p5v2018.xls") |> 
  select(scode, country, year, polity2, xrreg:parreg)
```



## Tidy data

We consider that a dataframe is *tidy* if it fulfills the following requirements [@Wickham2014]:

- Each dataframe has one **unit of observation**.
- **Observations** are represented in the rows.
- **Variables** are represented in the columns.
- Each **cell** indicates a value.

## RStudio workflow

**Load packages.**

```{r echo = T, message=F, warning=F}
library(dplyr)
library(readr)
library(stringr)
library(forcats)
```

![](img/r-packages.png){style="float:center;" width="650"}


# Observations {background-color="#e8e8e8"}

## Observing ...

:::: {.columns}

::: {.column width="40%"}
We need to decide which are the **units** of interest.
:::

::: {.column width="60%"}
![](https://2.bp.blogspot.com/-wA7H0iOgUgM/VtSymS91sfI/AAAAAAAAA1U/UEtXfoDg8j0/s1600/day_globe_75fr_125ms.gif)
:::

::::




## What is an observation? {.scrollable}

-	**Unit of analysis:** The thing that we want to know about.
    - Determined by the hypothesis / question.
-	**Unit of observation:** Each row of a dataframe.
    - Determined by the data.

[Ethnic Power Relations](https://icr.ethz.ch/data/epr/){target="_blank"}, International Conflict Research.

```{r}
read_csv("data/rfe.csv")
```




## Levels of analysis {.scrollable}

- **Macro level:** States, regions, legal systems.
- **Meso level:** Organitzations, ethnic groups, political parties.
- **Micro level:** Families, individuals, relationships.
  - Events: Bombings, contracts, terrorist attacks.

```{r}
read_csv("data/cam_list_3.0.csv") |> 
  select(-date)
```

[Coup Agency and Mechanisms Dataset](https://militarycoups.org/Codebook-v3.0.html){target="_blank"}


## Ecological fallacy

When the UA and the UO are not the same, we run the risk of having an ecological fallacy problem.

::: aside

- BERKELEY ADMISSIONS (see [Simpson's paradox](https://en.wikipedia.org/wiki/Simpson%27s_paradox){target="_blank"}).

```{r}
uni <- tibble(faculty = rep(c("Psysics", "Politics", "Journalism"), times = 1, each = 2),
              sex = rep(c("Men", "Women"), times = 3),
              applicants = c(825,108,325,593,181,392),
              admitted = c(520, 76, 119, 203, 52, 115))
uni |> 
  group_by(sex) |> 
  summarize(applicants = sum(applicants),
            admitted = sum(admitted)) |> 
  mutate(perc_admissions = round(admitted / applicants * 100, 2)) |> 
  knitr::kable()
```

- SUICIDE (critique to Durkheim).

```{r}
suicide <- tibble(region = c("Isère"),
                  municipality = rep(c("Grenoble", "Le Bourg-d'Oisans", "Saint-Jean-de-Maurienne"), times = 1, each = 2),
                  religion = rep(c("Protestant", "Catholic"), times = 3),
                  population = c(8250,1080,325,593,181,392),
                  suicide = c(520, 72, 12, 20, 5, 11))
suicide |> 
  group_by(religion) |> 
  summarize(population = sum(population),
            suicide = sum(suicide)) |> 
  mutate(perc_suicide = round(suicide / population * 100, 2)) |> 
  knitr::kable()
```
:::

## Ecological fallacy

Barcelona local elections: District level.

![](img/bcn1.png)

## Ecological fallacy

Barcelona local elections: Neighbourhood level.

![](img/bcn2.png)

## Ecological fallacy

Barcelona local elections: Census section level.

![](img/bcn3.png)



# Variables {background-color="#e8e8e8"}

## What is a variable?

A characteristic of the object we're studying.

- It **varies** across units.

```{r echo = F}
suicide <- tibble(region = c("Isère"),
                  municipality = rep(c("Grenoble", "Le Bourg-d'Oisans", "Saint-Jean-de-Maurienne"), times = 1, each = 2),
                  religion = rep(c("Protestant", "Catholic"), times = 3),
                  population = c(8250,1080,325,593,181,392),
                  suicide = c(520, 72, 12, 20, 5, 11))
suicide

```



## Types of variables (I): Nominal

Unordered categories:

- **Municipality:** Barcelona, Sant Cugat, Granollers...
- **Religion:** Muslim, Catholic, Shinto...
- **Language:** Russian, Catalan, Swedish.
- **Ideology:** Conservatism, Nationalism, Liberal...
- **Political parties:** PSOE, PP, Cs, ERC...

For strings, [`stringr`](https://stringr.tidyverse.org/){target="_blank"} [@R-stringr]. 

- [Cheatsheet](https://www.rstudio.com/resources/cheatsheets/){target="_blank"}.


## Types of variables (II): Ordinal

Ordered categories:

- **Things:** Small, Medium, Large.
- **Age:** Child, Young, Adult.
- **Education:** Primary, Secondary, Tertiary.
- **Ideas:** Disagree, Neutral, Agree.

For factors, [`forcats`](https://forcats.tidyverse.org/){target="_blank"} [@R-forcats].

- [Cheatsheet](https://www.rstudio.com/resources/cheatsheets/){target="_blank"}.


## Types of variables (III): Interval

Numbers, zero is arbitrary.

- **Year:** 2004, 2005, 2008, 2010.
- **Temperature** (except Kelvin)**:** 10, 25, 30.
- **Ideology:** Left-right measured as 0-10.
- **Coordinates:** Longitude and latitude.

Data available: [Polity V](https://www.systemicpeace.org/polityproject.html){target="_blank"}.


## Types of variables (IV): Ratio

Numbers, zero has meaning

- **Age:** 2, 5, 7, 9.
- **Percentages:** 0%, 34%, 100%.
- **Population:** 200, 3345000, 13000000.
- **Indices** (not all of them)**:** 0.245, 0.999.

Data available: [National Material Capabilities (NMC)](https://correlatesofwar.org/data-sets/national-material-capabilities){target="_blank"} dataset [@Singer1987; @Singer1972]. 

## Types of variables (V): Summary

```{r echo = FALSE}
tribble(~Tipus, ~Característiques, ~Vector, ~Operacions, 
        "Categòrica nominal", "Categories no ordenables", "Caràcter o factor", "==, !=",
        "Categòrica ordinal", "Categories ordenables", "Factor", "==, !=, <=, <, >, >=",
        "Numèrica d'interval", "Nombres, zero sense significat", "Numèric o enter", "==, !=, <=, <, >, >=, +, -",
        "Numèrica de ràtio", "Nombres, zero amb significat", "Numèric", "==, !=, <=, <, >, >=, +, -, *, / ...") |> 
  knitr::kable()
```


# Recoding variables {background-color="#e8e8e8"}

## Boolean operators


- **AND** (`&`): TRUE if all conditions are met.
- **OR** (`|`): TRUE if any condition is met.
- **NOT** (`!`): TRUE if conditions are not met.

```{r echo = FALSE}
#| fig-column: margin
knitr::include_graphics("img/booleans.png")
```


## Summary recoding


| Destí      | Funció                                          |
|------------|-------------------------------------------------|
| Binària    | `if_else()`                                     |
| Categòrica | `case_when()`                                   |
| Ordinal    | `factor()`                                      |
| Qualsevol  | `recode()`                                      |
| Altres     | `as.numeric()`, `as.character()`, `as.Date()`, etc. |



# Bibliography {background-color="#e8e8e8"}


---
title: "Ggplot2"
subtitle: "Quantitative Methodology (UPF)"
author: "Jordi Mas Elias"
institute: "<https://www.jordimas.cat/>"
footer: "Quantitative Methodology (UPF)"
logo: logo-upf.png
format: 
  revealjs:
    embed-resources: true
    slide-number: true
    show-slide-number: print
    theme: simple
editor: source
editor_options: 
  chunk_output_type: console
---

## Summary

- Facet
- Coordinates
- Scale
- Labels and themes

# Warm up {background-color="#e8e8e8"}

## R learning curve

```{r}
library(dplyr)
library(ggplot2)
library(ggthemes)
library(tidyr)
library(forcats)
library(readr)
library(lubridate)
theme_set(theme_minimal())
cens_gc <- readRDS("data/cens_gc.rds")
rendacs <- readRDS("data/rendacs.rds")
accidents <- readRDS("data/accidents.rds")
municipi <- readRDS("data/municipi.rds")
lloguer_any <- readRDS("data/lloguer_any.rds")
festivals <- readRDS("data/festivals.rds")
elecc19 <- readRDS("data/elecc19.rds")

rlc <- tibble(class = 1:8,
             knowledge = (1:8)^3)
lesson <- 7
rlc |> 
  ggplot(aes(x = class, y = knowledge)) +
  geom_line() +
  geom_point(data = rlc |> 
               filter(class == lesson), col = "red", size = 3)
```



# Layers {background-color="#e8e8e8"}

## Basic layers

Almost always, a ggplot consists of three layers^[Layers are separated by `+`, not by a pipe!!!!]:

- 1. Dataframe
- 2. Aesthetics
- 3. Geometry

```{r echo = T, eval = F}
#| code-line-numbers: 4-7
df |> 
  ggplot(aes(aestethics)) +
  geometry() +
  facet() +
  scale() +
  theme() +
  ...
```



## Optional layers

Optionally, we add more layers, such as:

- 4. Facet
- 5. Coordinates
- 6. Scale
- 7. Theme
- 8. Etc


# Facet {background-color="#e8e8e8"}


## Facet {.scrollable}

Col: `facet_wrap(facets=vars(v), ncol=1)`

```{r echo = T}
#| code-fold: true
elecc19 |> 
  filter(nombre_de_comunidad == "Cataluña") |> 
  mutate(pp_per = pp / total_votantes * 100) |> 
  ggplot(aes(x = pp_per)) +
  geom_histogram() +
  facet_wrap(facets = vars(nombre_de_provincia), ncol = 1)
```

## Facet {.scrollable}

Row: `facet_wrap(facets=vars(v), nrow=1)`

```{r echo = T}
#| code-fold: true
elecc19 |> 
  filter(nombre_de_comunidad == "Cataluña") |> 
  mutate(erc_per = erc_sobiranistes / total_votantes * 100,
         psoe_per = psoe / total_votantes * 100,
         hab = if_else(poblacion > 15000, "Ciutat", "Poble")) |> 
  ggplot(aes(x = erc_per, y = psoe_per, col = hab)) +
  geom_point() +
  facet_wrap(facets = vars(nombre_de_provincia), 
             nrow = 1, scales = "free")
```


## Facet {.scrollable}

None: `facet_wrap(facets=vars(v))` ([CatSalut](https://analisi.transparenciacatalunya.cat/Salut/Dades-di-ries-de-COVID-19-per-comarca/c7sd-zy9j))

```{r eval = F, echo = T}
#| code-fold: true
library(lubridate)
covid <- read_csv("data/Dades_di_ries_de_COVID-19_per_comarca.csv")
covid |> 
  filter(NOM != "Sense especificar") |> 
  mutate(DATA = as.Date(DATA, format = "%d/%m/%Y"),
         MONTH = month(DATA),
         YEAR = year(DATA)) |> 
  group_by(NOM, MONTH, YEAR) |> 
  summarize(casos = sum(CASOS_CONFIRMAT)) |> 
  mutate(DATE = as.Date(paste0("01/", MONTH, "/", YEAR), format = "%d/%m/%Y")) |> 
  ggplot(aes(x = DATE, y = casos)) +
  geom_line() +
  facet_wrap(facets = vars(NOM), scales = "free")
```

```{r echo = F, eval = T, fig.height=4, fig.width=9}
covid <- readRDS("data/covid.rds")
covid |> 
  filter(NOM != "Sense especificar") |> 
  mutate(DATA = as.Date(DATA, format = "%d/%m/%Y"),
         MONTH = month(DATA),
         YEAR = year(DATA)) |> 
  group_by(NOM, MONTH, YEAR) |> 
  summarize(casos = sum(CASOS_CONFIRMAT)) |> 
  mutate(DATE = as.Date(paste0("01/", MONTH, "/", YEAR), format = "%d/%m/%Y")) |> 
  ggplot(aes(x = DATE, y = casos)) +
  geom_line() +
  facet_wrap(facets = vars(NOM), scales = "free")
```

## Facet {.scrollable}

Rows and cols in a grid: `facet_grid()`
```{r echo = T}
#| code-fold: true
accidents |>
  ggplot(aes(x = edat)) +
  geom_histogram() +
  facet_grid(rows = vars(descripcio_dia_setmana),
             cols = vars(descripcio_torn))
```



# Coordinates {background-color="#e8e8e8"}

## Coordinates {.scrollable}

Flip axis: `coord_flip()`

:::: {.columns}

::: {.column width="50%"}
```{r echo = T, fig.height=5, fig.width=6}
#| code-fold: true
elecc19 |>
  filter(nombre_de_comunidad == "Andalucía") |> 
  mutate(cs_per = cs / poblacion * 100) |> 
  ggplot(aes(x = fct_reorder(nombre_de_provincia, cs_per), y = cs_per)) +
  geom_violin()
```

:::

::: {.column width="50%"}
```{r echo = T, fig.height=5, fig.width=6}
#| code-fold: true
elecc19 |>
  filter(nombre_de_comunidad == "Andalucía") |> 
  mutate(cs_per = cs / poblacion * 100) |> 
  ggplot(aes(x = fct_reorder(nombre_de_provincia, cs_per), y = cs_per)) +
  geom_violin() +
  coord_flip()
```

:::

::::


## Coordinates {.scrollable}

Change limits: `coord_cartesian(ylim = c(30,40))`

:::: {.columns}

::: {.column width="50%"}
```{r echo = T}
#| code-fold: true
rendacs |> 
  ggplot(aes(x = import_euros, y = index_gini, col = nom_districte)) +
  geom_point()
```
:::

::: {.column width="50%"}
```{r echo = T}
#| code-fold: true
rendacs |> 
  ggplot(aes(x = import_euros, y = index_gini, col = nom_districte)) +
  geom_point() +
  coord_cartesian(ylim = c(30, 40))
```

:::

::::

Easier: `ylim(30,40)` / `xlim(30000,70000)`


# Scale {background-color="#e8e8e8"}

## X and Y scales {.scrollable}

Scale function: 

- `scale_x_` or `scale_y_`
- `discrete()` or `continuous()` (and others).

Arguments of the function:

- `breaks`: Position of the breaks.
- `labels`: Label of the breaks.
- `name`: Title of the axis.
- `limits`: Limits of the scale.

## X and Y scales {.scrollable}

Num: `scale_x_continuous()`

```{r echo = T}
#| code-fold: true
rendacs |> 
  ggplot(aes(x = import_euros, y = index_gini, col = nom_districte)) +
  geom_point() +
    scale_x_continuous(
    breaks = c(20000, 50000, 80000), 
    labels = c("20k", "50k", "80k")
  )
```

## X and Y scales {.scrollable}

Cat: `scale_x_discrete()`

```{r echo = T}
#| code-fold: true
elecc19 |> 
  filter(nombre_de_comunidad == "Cataluña") |> 
  ggplot(aes(x = nombre_de_provincia, y = numero_de_mesas)) +
  geom_col() +
  scale_x_discrete(labels = c("BCN", "GIR", "LLEI", "TGN"),
                   name = "Província")
```


## X and Y scales {.scrollable}

Percentages: Numeric variable from 0 to 1.

```{r echo = T}
#| code-fold: true
elecc19 |> 
  filter(nombre_de_comunidad == "Cataluña") |> 
  mutate(erc_per = erc_sobiranistes / total_votantes,
         psoe_per = psoe / total_votantes,
         hab = if_else(poblacion > 15000, "Ciutat", "Poble")) |> 
  ggplot(aes(x = erc_per, y = psoe_per, col = hab)) +
  geom_point() +
  scale_y_continuous(labels = scales::label_percent())
```



## Color and fill scales {.scrollable}

Scale function: **Brewer**.

- `scale_color_brewer()`
- `scale_fill_brewer()`

Arguments of the function (see help):

- `type`: `"seq"`, `"div"` or `"qual"`.
- `palette`: `"Greens"`, `"Set1"`, `"Spectral"` (1, 2...).
- `direction`: `1` or `-1`.


## Color and fill scales {.scrollable}

Scale function: **Brewer** ([see web](https://colorbrewer2.org){target="_blank"}).

```{r echo = T}
#| code-fold: true
elecc19 |> 
  filter(nombre_de_comunidad == "Cataluña") |> 
  ggplot(aes(x = nombre_de_provincia, y = numero_de_mesas,
             fill = nombre_de_provincia)) +
  geom_col() +
  scale_fill_brewer(palette = "Accent")
```


## Color and fill scales {.scrollable}

Scale function: **Gradient**^[`scale_xxx_gradient2()` includes `mid` and `midpoint`.].

- `scale_color_gradient()`
- `scale_fill_gradient()`

Arguments of the function:

- `low`: color of the lowest value.
- `high`: color of the highest value. 



## Color and fill scales {.scrollable}

Scale function: **Gradient**.


```{r echo = T}
#| code-fold: true
elecc19 |> 
  filter(nombre_de_comunidad == "Cataluña") |> 
  mutate(erc_per = erc_sobiranistes / total_votantes,
         psoe_per = psoe / total_votantes,
         pp_per = pp / total_votantes) |> 
  ggplot(aes(x = erc_per, y = psoe_per, col = pp_per)) +
  geom_point() +
  scale_color_gradient(low = "white", high = "darkblue")
```


## Color and fill scales {.scrollable}

Scale function: **Manual**.

- `scale_color_manual()`
- `scale_fill_manual()`

Arguments of the function:

- `values`: color of each category.
- `labels`: name of each category.


## Color and fill scales {.scrollable}

Scale function: **Manual**.

```{r echo = T}
#| code-fold: true
elecc19 |> 
  filter(nombre_de_comunidad == "Cataluña") |> 
  mutate(erc_per = erc_sobiranistes / total_votantes,
         psoe_per = psoe / total_votantes,
         hab = if_else(poblacion > 15000, "Ciutat", "Poble")) |> 
  ggplot(aes(x = erc_per, y = psoe_per, col = hab)) +
  geom_point() +
  scale_color_manual(values = c("orange", "darkgreen"),
                  labels = c("Ciutat", "Poble"))
  
```


## Color and fill scales {.scrollable}

Useful websites for colors:

- [R colors](http://www.stat.columbia.edu/~tzheng/files/Rcolor.pdf){target="_blank"}
- [Html color codes](https://htmlcolorcodes.com){target="_blank"}
- [Color Hex](https://www.color-hex.com){target="_blank"}


## Other scales {.scrollable}

- `scale_size()`
- `scale_shape()`
- `scale_alpha()`
- `scale_linewidth()`



# Labels and themes

## Labels

`labs()`

- `title`, `subtitle`, `caption`...
- `x`, `y`, `col`, `fill`...


## Ggplot themes {.scrollable}

`theme_minimal()`, `theme_light()`...

```{r echo = T}
#| code-fold: true
rendacs |> 
  ggplot(aes(x = import_euros, y = index_gini, col = nom_districte)) +
  geom_point() +
  theme_classic()
```



## Other theme packages {.scrollable}

WSJ, The Economist, Excel... `ggthemes`.

```{r echo = T}
#| code-fold: true
library(ggthemes)
rendacs |> 
  ggplot(aes(x = import_euros, y = index_gini, col = nom_districte)) +
  geom_point() +
  scale_color_wsj() +
  theme_wsj()
```

## Modifying themes {.scrollable}

Very time consuming, at the beginning.

See [ggplot2](https://ggplot2.tidyverse.org/reference/theme.html){target="_blank"} info.



# Full-equipped example {background-color="#e8e8e8"}

## Example {.scrollable}

```{r echo = T}
#| code-fold: true
options(scipen=999) #removes scientific notation
elecc19 |> 
  filter(nombre_de_comunidad == "Cataluña") |> 
  transmute(poblacion, 
            ERC = erc_sobiranistes / total_votantes,
            PSC = psoe / total_votantes) |> 
  pivot_longer(ERC:PSC, names_to = "partit", values_to = "perc") |> 
  ggplot(aes(x = log10(poblacion), y = perc, col = partit)) +
  geom_point(size = 2, alpha = 0.6, show.legend = F) +
  facet_wrap(facets = vars(partit), 
             nrow = 1) +
  scale_color_manual(values = c("gold2", "firebrick2")) +
  scale_y_continuous(labels = scales::label_percent(), name = "Percentatge de vot") +
  scale_x_continuous(name = "Població", breaks = c(2, 3, 4, 5, 6),
                     labels = c(100, 1000, 10000, 100000, 1000000)) +
  labs(title = "Vot a ERC i PSC a Catalunya",
       subtitle = "Dades de vot per municipi a les eleccions generals de 2019",
       caption = "Font: Ministeri de l'Interior") +
  theme(text = element_text(size = 15))
```



## Important

Use Cheat Sheet & Manuals:

- [Cheat Sheet](https://posit.co/resources/cheatsheets/){target="_blank"}
- [R4DS: Data visualization](https://r4ds.hadley.nz/data-visualize.html){target="_blank"}
- [R4DS: Visualize](https://r4ds.hadley.nz/visualize.html){target="_blank"}
- [ggplot2 package info](https://ggplot2.tidyverse.org/reference/scale_continuous.html){target="_blank"}
- [ggplot2: Elegant graphics for data analysis](https://ggplot2-book.org/index.html){target="_blank"}
- Google it! E.g. "Geom tile covid examples".



## More vizz

- [Datawrapper](https://xarxanet.org/informatic/recursos/com-fer-un-grafic-interactiu-amb-datawrapper)



---
title: "Tidy data"
subtitle: "Quantitative Methodology (UPF)"
author: "Jordi Mas Elias"
institute: "<https://www.jordimas.cat/>"
footer: "Quantitative Methodology (UPF)"
logo: logo-upf.png
bibliography: [references.bib, packages.bib]
format: 
  revealjs:
    embed-resources: true
    slide-number: true
    show-slide-number: print
    theme: simple
editor: source
editor_options: 
  chunk_output_type: console
---

## Summary

-   Introduction
-   Messy data
-   Missing data
-   Separate data
-   Codes and codebooks

```{r echo = F, message=F, warning=F}
library(tidyverse)
library(readxl)
library(countrycode)
elecc19 <- readRDS("data/elecc19.rds")
festivals <- readRDS("data/festivals.rds")
lloguer_any <- readRDS("data/lloguer_any.rds")
cens_gc <- readRDS("data/cens_gc.rds")
municipi <- readRDS("data/municipi.rds")
rendacs <- readRDS("data/rendacs.rds")
contractes_menors <- readRDS("data/contractes_menors.rds")
```

# Warm up {background-color="#e8e8e8"}

## Warm up

Data wrangling

![](img/minority.gif)


## R learning curve

```{r}
library(dplyr)
library(ggplot2)
rlc <- tibble(class = 1:8,
             knowledge = (1:8)^3)
lesson <- 8
rlc |> 
  ggplot(aes(x = class, y = knowledge)) +
  geom_line(size = 1) +
  annotate("text", x = 4.5, y = 375, label = "?", size = 12) +
  theme_minimal() +
  labs(x = "Class number", y = "Knowledge", title = "The R Knowledge curve")
```


## Warm up

```{r}
rlc <- tibble(class = 1:100,
              knowledge = (1:100)^3)
lesson <- 10

rlc |> 
  ggplot(aes(x = class, y = knowledge)) +
  geom_line() +
  geom_point(data = rlc |> 
               filter(class == lesson), col = "red") +
  annotate("text", x = 36, y = 260000, label = "You are here!") +
  geom_curve(aes(x = 25, xend = 9.8, 
                 y = 250000, yend = 15000),
             arrow = arrow(length = unit(0.08, "inch")), size = 0.5,
             color = "gray40", curvature = 0.3) +
  theme_minimal() +
  labs(x = "Class number", y = "Knowledge", title = "The R Knowledge curve")
```

## Warm up

**Install packages**

```{r eval = F, echo = T, message=F, warning=F}
install.packages(c("dplyr", "ggplot2", "readr", "tidyr", 
                   "countrycode", "janitor", "readxl", 
                   "wbstats", "naniar", "haven", "Hmisc"))
```


## Warm up

**Load packages**

```{.r code-line-numbers="4"}
library(dplyr)
library(ggplot2)
library(readr)
library(tidyr)
library(countrycode)
library(janitor)
library(readxl)
library(wbstats)
library(naniar)
library(haven)
library(Hmisc)
```

![](img/r-packages.png){style="float:center;" width="650"}





# Introduction {background-color="#e8e8e8"}

## Introduction

> "Data Scientists spend up to 80% of the time on data cleaning and 20% on actual data analysis".

![Source: R for Data Science](img/whole-game.png)


## Introduction {.scrollable}

A _df_ is *tidy* if it fulfills these requirements [@Wickham2014]:

![](img/wickham.jpeg){style="float:right;" width="300"}

::: columns
::: {.column width="70%"}

- Each _df_ has one **unit of observation**.
- **Observations** represented in the rows.
- **Variables** represented in the columns.
- Each **cell** indicates a value.
:::

::: {.column width="25%"}
:::

![Source: R for Data Science](img/tidydata.png)
:::

## Introduction  {.smaller}

But ...

**Votes to parties in the 2019 Spanish elections**

```{r}
elecc19 |>
  select(provincia = nombre_de_provincia, municipio = nombre_de_municipio, votos_validos, pp, cs, podemos_iu, mas_pais, eb, pacma) |> 
  head(15)
```

## Introduction  {.smaller}

But ...

**Minor contracts granted in Barcelona**

```{r}
contractes_menors |> 
  filter(data_adjudicacio == "2918-11-19" | is.na(data_adjudicacio)) |> 
  select(ens = tipus_ens, contracte = tipus_contracte, data = data_adjudicacio,
         proveidor, import = import_adjudicat) |> 
  head(15)
```

## Introduction {.smaller}


But ...


::: columns
::: {.column width="50%"}
**Price of rents**

```{r}
lloguer_any |> 
  select(nom_barri, preu, preu_m2) |> 
  head(15)
```
:::

::: {.column width="10%"}

:::

::: {.column width="40%"}
**Income per capita**
```{r}
rendacs |> 
  select(nom_barri, sc = seccio_censal, import_euros) |> 
  head(15)
```

:::


:::



## Introduction

Often, data is not tidy because it's:

- **Messy:** Variables are not represented in the columns.
- **Missing:** Cells do not contain a value.
- **Separated:** Observations are in many datasets.




# Messy data {background-color="#e8e8e8"}



## Tidy data? {.smaller}

Number of TB cases documented by WHO in Afghanistan, Brazil, and China between 1999 & 2000 (cases & population) (example from @R-tidyr).

:::: {.columns}

::: {.column width="50%"}
Table A
```{r}
table3
```

Table B
```{r}
table1
```
:::

::: {.column width="50%"}
Table C

```{r}
table2
```

Table D
```{r}
table4a
```
:::
::::



## Pivoting data

We change the rows and columns of the dataframe keeping the same information.

- Pivot longer: `pivot_longer(df, cols, names_to, values_to)`
- Pivot wider: `pivot_wider(df, names_from, values_from)`
- Separate: `separate(df, col, into, sep)`
- Unite: `unite(df, col, ..., sep)`


## Why data is not tidy?

Three reasons, among others:

- Saves space (see [IGO dataset](https://correlatesofwar.org/data-sets/igos/){target="_blank"})
- Spreadsheet mindset.
- Tidyverse revolution^[More datasets examples available in the `tidyr::` package.].




#  Missing data {background-color="#e8e8e8"}

## What is missing data?

Zero vs. NA (Not Available)

![](https://preview.redd.it/3370lkxk56ny.jpg?width=960&crop=smart&auto=webp&s=61a1bae1128914c9c7fc1eb0b02cc44189e78a5f)


## Why is data missing?

Special categories: People do not answer.

```{r}
nig <-read_csv("data/nig.csv")
nig |> 
  select(age, language, situation_country, situation_personal)
```

## Why is data missing?

Special categories: Hard to qualify.

```{r}
polity <- read_xls("data/p5v2018.xls")
polity |>
  select(ccode, scode, country, year, polity, polity2) |>
  filter(year > 1990, country == "South Africa")
```


## Why is data missing?

Not known (NA) or strange/extreme value.

```{r}
lloguer_any |> 
  rename(trim = trimestre, codi_dist = codi_districte, districte = nom_districte) |> 
  filter(preu < 260)
```


## Why is data missing?

Data join typically produces `NA`.

- See next chapter

## Dealing with missing data

Some functions:

- `summary()` for exploration.
- `is.na()` is useful when filtering.
- `na.rm = TRUE` argument in summary functions.
- `replace_na()` assigns a value to NAs.
- `naniar::vis_miss()` (be careful!!)

## Dealing with missing data

The real problem is when the reason why data is missing is related to what we are studying:

- Why students don't come to class? 
- Why is there poverty in the world? 






#  Join data {background-color="#e8e8e8"}

## Join data


```{r echo = T, eval = F}
xxxx_join(df1, 
          df2, 
          by = c("join_variable_df1" = "join_variable_df2"))
```

- `full_join()`
- `left_join()`
- `right_join()`
- `inner_join()`



## Join data

![](https://www.csestack.org/wp-content/uploads/2020/10/sql-table-joins.png)

## Classification territorial units & parties

- States: [Countrycode](https://www.rdocumentation.org/packages/countrycode/versions/1.4.0/topics/countrycode){target="_blank"}, [ISO 3166-1](https://www.iso.org/iso-3166-country-codes.html){target="_blank"}, [Eurostat](https://ec.europa.eu/eurostat/statistics-explained/index.php?title=Glossary:Country_codes){target="_blank"}.
- Regions: [UN](https://population.un.org/wpp/DefinitionOfRegions/){target="_blank"}.
- Intergovernmental Organizations: [COW](https://correlatesofwar.org/data-sets/igos/){target="_blank"}
- Political parties: [Party facts](https://partyfacts.herokuapp.com){target="_blank"}.
- Regions: [NUTS](https://www.idescat.cat/codis/?id=52&n=1&lang=es){target="_blank"} / [ISO 3166-2](https://www.iso.org/obp/ui/es/#iso:code:3166:ES){target="_blank"}.
- Municipalities: [IDESCAT](https://www.idescat.cat/codis/?id=50&n=9){target="_blank"}, [INE](https://www.ine.es/daco/daco42/codmun/codmunmapa.htm){target="_blank"}.
- Census sections: [IDESCAT](https://www.idescat.cat/codis/?id=50&n=81).



#  Codebooks {background-color="#e8e8e8"}

##  Codebooks

Examples:

- CHES dataset: [Web](https://www.chesdata.eu/ches-europe){target="_blank"} 
- UCDP: [Web](https://ucdp.uu.se/downloads/){target="_blank"}
- World Bank `wbstats` package.




##  Bibliography {background-color="#e8e8e8"}

---
title: "Tidy data"
subtitle: "Quantitative Methodology (UPF)"
author: "Jordi Mas Elias"
institute: "<https://www.jordimas.cat/>"
footer: "Quantitative Methodology (UPF)"
logo: logo-upf.png
bibliography: references.bib
format: 
  revealjs:
    embed-resources: true
    slide-number: true
    show-slide-number: print
    theme: simple
editor: source
editor_options: 
  chunk_output_type: console
---

## Summary

-   Introduction
-   Untidy data
-   Missing data
-   Separate data
-   Codes and codebooks

```{r echo = F, message=F, warning=F}
library(tidyverse)
library(readxl)
library(countrycode)
elecc19 <- readRDS("data/elecc19.rds")
festivals <- readRDS("data/festivals.rds")
lloguer_any <- readRDS("data/lloguer_any.rds")
cens_gc <- readRDS("data/cens_gc.rds")
municipi <- readRDS("data/municipi.rds")
rendacs <- readRDS("data/rendacs.rds")
contractes_menors <- readRDS("data/contractes_menors.rds")
```

# Warm up {background-color="#e8e8e8"}

## R learning curve

```{r}
library(dplyr)
library(ggplot2)
rlc <- tibble(class = 1:8,
             knowledge = (1:8)^3)
lesson <- 8
rlc |> 
  ggplot(aes(x = class, y = knowledge)) +
  geom_line(size = 1) +
  annotate("text", x = 4.5, y = 375, label = "?", size = 12) +
  theme_minimal() +
  labs(x = "Class number", y = "Knowledge", title = "The R Knowledge curve")
```


## Warm up

```{r}
rlc <- tibble(class = 1:100,
              knowledge = (1:100)^3)
lesson <- 10

rlc |> 
  ggplot(aes(x = class, y = knowledge)) +
  geom_line() +
  geom_point(data = rlc |> 
               filter(class == lesson), col = "red") +
  annotate("text", x = 36, y = 260000, label = "You are here!") +
  geom_curve(aes(x = 25, xend = 9.8, 
                 y = 250000, yend = 15000),
             arrow = arrow(length = unit(0.08, "inch")), size = 0.5,
             color = "gray40", curvature = 0.3) +
  theme_minimal() +
  labs(x = "Class number", y = "Knowledge", title = "The R Knowledge curve")
```

## Warm up

**Load packages.**

```{r echo = T, message=F, warning=F}
library(dplyr)
library(ggplot2)
library(readr)
library(tidyr) # <- tidytidytidy
library(countrycode)
```

![](img/r-packages.png){style="float:center;" width="650"}





# Introduction {background-color="#e8e8e8"}

## Introduction

> "Data Scientists spend up to 80% of the time on data cleaning and 20% on actual data analysis".

![Source: R for Data Science](img/whole-game.png)


## Introduction {.scrollable}

A _df_ is *tidy* if it fulfills these requirements [@Wickham2014]:

![](img/wickham.jpeg){style="float:right;" width="300"}

::: columns
::: {.column width="70%"}

- Each _df_ has one **unit of observation**.
- **Observations** represented in the rows.
- **Variables** represented in the columns.
- Each **cell** indicates a value.
:::

::: {.column width="25%"}
:::

![Source: R for Data Science](img/tidydata.png)
:::

## Introduction  {.smaller}

But ...

**Votes to parties in the 2019 Spanish elections**

```{r}
elecc19 |>
  select(provincia = nombre_de_provincia, municipio = nombre_de_municipio, votos_validos, pp, cs, podemos_iu, mas_pais, eb, pacma) |> 
  head(15)
```

## Introduction  {.smaller}

But ...

**Minor contracts granted in Barcelona**

```{r}
contractes_menors |> 
  filter(data_adjudicacio == "2918-11-19" | is.na(data_adjudicacio)) |> 
  select(ens = tipus_ens, contracte = tipus_contracte, data = data_adjudicacio,
         proveidor, import = import_adjudicat) |> 
  head(15)
```

## Introduction {.smaller}


But ...


::: columns
::: {.column width="50%"}
**Price of rents**

```{r}
lloguer_any |> 
  select(nom_barri, preu, preu_m2) |> 
  head(15)
```


:::

::: {.column width="50%"}
**Income per capita**
```{r}
rendacs |> 
  select(nom_barri, sc = seccio_censal, import_euros) |> 
  head(15)
```

:::


:::



## Introduction

Data is _untidy_ because is:

- Variables are not represented in the columns.
- **Missing:** Cells do not contain a value.
- **Separate:** Observations are in many datasets.




# Tidy data {background-color="#e8e8e8"}



## Untidy datasets? {.smaller}

Number of TB cases documented by the WHO in Afghanistan, Brazil, and China between 1999 and 2000 (cases & population).

:::: {.columns}

::: {.column width="50%"}
Table A
```{r}
table3
```

Table B
```{r}
table1
```
:::

::: {.column width="50%"}
Table C

```{r}
table2
```

Table D
```{r}
table4a
```
:::
::::



## A tidy dataframe

NOO ANOTHER

Correlates of War [Intra-State War Data](https://correlatesofwar.org/data-sets/cow-war/)

```{r}
interstate <- read_csv("data/Intra-StateWarData_v4.1.csv")
interstate |> 
  select(WarName, WarType, SideA, SideB)
```

## An untidy dataframe

PEW Research [Religious Landscape Study](https://www.pewresearch.org/religion/religious-landscape-study/)^[More datasets available in the `tidyr::` package.]

```{r}
tidyr::relig_income |> 
  select(1:6)
```



## Pivoting data

We change the rows and columns of the dataframe keeping the same information.

- Pivot longer
```
pivot_longer(df, cols, names_to, names_to)
```

- Pivot wider
```
pivot_wider(df, names_from, values_from)
```

- Separate

```
separate(df, col, into, sep)
```

- Unite

```
unite(df, col, ..., sep)
```


#  Join data {background-color="#e8e8e8"}

## Join data

## Classifications

- States: [Countrycode](https://www.rdocumentation.org/packages/countrycode/versions/1.4.0/topics/countrycode), [ISO 3166-1](https://www.iso.org/iso-3166-country-codes.html), [Eurostat](https://ec.europa.eu/eurostat/statistics-explained/index.php?title=Glossary:Country_codes).
- Regions: [UN](https://population.un.org/wpp/DefinitionOfRegions/).
- Intergovernmental Organizations: [COW](https://correlatesofwar.org/data-sets/igos/)
- Political parties: [Party facts](https://partyfacts.herokuapp.com).
- Regions: 3166-2.
- Municipalities: [IDESCAT](https://www.idescat.cat/codis/?id=50&n=9), [INE](https://www.ine.es/daco/daco42/codmun/codmunmapa.htm).
- Census sections: [IDESCAT](https://www.idescat.cat/codis/?id=50&n=81).







#  Missing data {background-color="#e8e8e8"}


## Why they are missing?

NA (Not Available)

Related with the state capacity to collect them [@Stone2008]

Check the World Bank

Small or underdeveloped states


is.na()





#  Codebooks {background-color="#e8e8e8"}



##  Bibliography {background-color="#e8e8e8"}

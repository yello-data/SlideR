---
title: "RMarkdown"
subtitle: "Postgrau d'Analista de Dades (UB)"
author: "Jordi Mas Elias"
institute: "<https://www.jordimas.cat/>"
footer: "RMarkdown - Postgrau d'Analista de Dades (UB)"
logo: ub-logo.png
params:
  country: "Denmark"
  year: 2014
format: 
  revealjs:
    slide-number: true
    show-slide-number: print
    theme: simple
editor: visual
---

## Sumari

```{r}
library(tidyverse)
library(readxl)
```

1.  Què és RMarkdown?
2.  Repàs primeres sessions
3.  Tutorial RMarkdown
4.  RMarkdown avançat
5.  Consideracions finals

# 1. Què és RMarkdown? {background-color="#e8e8e8"}

## Un paquet d'R

S'instal·la com qualsevol altre.

![](img/rmd-package.png){style="float:right;" fig-alt="RMarkdown logo." width="300"}

```{r echo = T, eval = F}
install.packages(c("rmarkdown",
                   "knitr", 
                   "DT"))
```

![](img/r-packages.png){style="float:center;" width="650"}

## Un llenguatge/prosa {.scrollable}

> "A Markdown-formatted document should be publishable as-is, as plain text, without looking like it’s been marked up with tags or formatting instructions"

![](img/gruber.png){style="float:right;" fig-alt="Illustration of three species of Palmer Archipelago penguins: Chinstrap, Gentoo, and Adelie. Artwork by @allison_horst." width="300"}

::: columns
::: {.column width="50%"}
-   John **Gruber**, 2004.
-   Un format més **fàcil de llegir** i d'escriure que la majoria de llenguatges web com l'Html.
-   **Convertible** fàcilment a Html, Pdf...
:::

::: {.column width="40%"}
:::


```{r eval = T, fig.align='center', fig.width=20}
knitr::include_graphics("img/html-code.png")
```
:::

## Eina per a presentar resultats {.scrollable}

::: columns
::: {.column width="50%"}
-   Imprescindible per a un bon analista de dades.
-   Permet transformar en un ampli rang de formats el codi d'R.
-   Exemples:
:::

::: {.column width="40%"}
```{r eval = T, fig.align='center', fig.width=20}
knitr::include_graphics("img/rmd-formats.png")
```
:::
:::

::: aside
-   [https://rmarkdown.rstudio.com/gallery.html](https://rmarkdown.rstudio.com/gallery.html){target="_blank"}
-   [https://quarto.org/docs/gallery/](https://quarto.org/docs/gallery/){target="_blank"}
-   [https://www.jordimas.cat/](https://www.jordimas.cat/){target="_blank"}
:::

# 2. Repàs primeres sessions {background-color="#e8e8e8"}

## RStudio

::: incremental
-   Crear projecte
-   Diferència entre instal·lar i carregar paquets
-   Utilitzar l'Environment
-   Importar arxius: csv, csv2, xlsx, dta, sav...
:::

## RMarkdown

Crear un document: YAML - Text - Chunk

![](img/rmd.png){style="float:left;" fig-alt="RMarkdown logo." width="290"}

## Descarregar tutorial

<https://www.jordimas.cat/files/Tutorial_Rmd_Polity.zip>

![](img/polity-map.png)

# 3. Tutorial RMarkdown {background-color="#e8e8e8"}

## Exercici 1

Crear una petita història amb **Polity V**:

-   Descarregar la base de dades Polity V a <https://www.systemicpeace.org/inscrdata.html>
-   **Text** amb tots els formats possibles.
-   Un **marc de dades** i dos **plots**.

::: aside
Variables d'interès:

-   `country`: país.
-   `year`: any.
-   `polity2`: democràcia (-10 + 10).
-   `durable`: anys de durada del règim.
:::

## Slide with a pause

content before the pause

. . .

content after the pause

## Slide Title {.smaller}

Holi holi

## Slide Title {.scrollable}

## Footers

-   Green [^1]
-   Brown
-   Purple

[^1]: A footnote

::: aside
Some additional commentary of more peripheral interest.
:::

::: footer
Custom footer text
:::

## Code

``` {.r code-line-numbers="2-3"}
install.packages(c("rmarkdown",
                   "knitr", 
                   "DT"))
```

Holi

``` {.r code-line-numbers="2,4"}
install.packages(c("rmarkdown",
                   "dplyr",
                   "ggplot2",
                   "knitr", 
                   "DT"))
```

Holi

``` {.r code-line-numbers="|2|4"}
install.packages(c("rmarkdown",
                   "dplyr",
                   "ggplot2",
                   "knitr", 
                   "DT"))
```

## Executable code

```{r echo = TRUE}
#| code-line-numbers: "|2|4"
starwars |> 
  select(name:last_col()) |> 
  filter(hair_color == "blond") |> 
  arrange(height)
```

# 4.1. RMarkdown avançat (YAML) {background-color="#e8e8e8"}

## Data automàtica

Quan fem **Knit**, ens imprimeix automàticament el dia d'avui.

```{r eval = F, echo = T}
date: "`r Sys.Date()`"
```

```{r eval = T, echo = F}
Sys.Date()
```

. . .

```{r eval = F, echo = T}
date: "`r format(Sys.time(), '%d %B %Y')`"
```

```{r eval = T, echo = F}
format(Sys.time(), '%d %B %Y')
```

. . .

```{r eval = F, echo = T}
date: "Última edició `r format(Sys.time(), '%d %B %Y')`"
```

```{r eval = T, echo = F}
paste0("Última edició ", format(Sys.time(), '%d %B %Y'))
```

## Foto d'encapçalament

Posem una foto a la capçalera del document.

```{r eval = F, echo = T}
title: "![Posar nom de títol](polity-index.jpeg){width=2in}"
```

![](img/polity-index.jpeg){width="2"}

## Taula de continguts

Customitzem elements de la taula de continguts.

``` {.r code-line-numbers="3-8"}
output:
  html_document:
    toc: true
    toc_depth: 2
    number_sections: true
    toc_float:
      collapsed: false
        smooth_scroll: false
```

::: aside
-   `toc:` volem taula de continguts?
-   `toc_depth:` de quina profunditat?
-   `number_sections:` les seccions han d'anar enumerades?
-   `toc_float:` la taula de continguts ha de ser flotant?
    -   `collapsed:` s'amaga automàticament?
    -   `smooth_scroll:` navegació suau.
:::

## Tema

Seleccionem l'estil visual i el subratllat:

-   **Tema:** default, cerulean, journal, flatly, darkly, readable, spacelab, united, cosmo, lumen, paper, sandstone, simplex, yeti, null.

```{r eval = F, echo = T}
theme: paper
```

-   **Highlight:** default, tango, pygments, kate, monochrome, espresso, zenburn, haddock, breezedark, textmate, null.

```{r eval = F, echo = T}
highlight: tango
```

::: aside
Per una llista dels diferents estils de temes i subratllats veure [aquest enllaç](https://bookdown.org/yihui/rmarkdown/html-document.html#appearance-and-style) i per una llista amb contingut més avançat veure [aquesta llista](https://www.datadreaming.org/post/r-markdown-theme-gallery/).
:::

## Gràfics per defecte

Els gràfics que apareixen al document han de tenir per defecte algunes dimensions determinades?

``` {.r code-line-numbers="4-5"}
title: "Postgrau d'Analista de Dades (UB)"
output:
  html_document:
    fig_width: 6 
    fig_height: 4 
```

## Paràmetres {.scrollable}

Establim uns paràmetres al YAML que al llarg del document podrem utilitzar com a codi [^2].

[^2]: Molt útil per fer [documents interactius](https://bookdown.org/yihui/rmarkdown/params-knit.html#params-knit) per establir els paràmetres de base.

``` {.r code-line-numbers="3-5"}
title: "Postgrau d'Analista de Dades (UB)"
author: "Jordi Mas Elias"
params:
  country: "Denmark"
  year: 2014
```

::: aside
En el document, accedim als paràmetres de dues maneres:

-   A. Al text,

```{r echo = T, eval = F}
`r params$country`
```

-   B. Als chunks,

```{r echo = T, eval = F}
filter(dataset, country == params$country)
```
:::

## Plegar codi

Creem un desplegable per cada chunk amb codi `(echo = T)` que tinguem al document.

``` {.r code-line-numbers="4"}
title: "Postgrau d'Analista de Dades (UB)"
output:
  html_document:
    code_folding: hide
```

## Formats d'output

Al YAML podem especificar el tipus de format[^3].

[^3]: Per una visió general de totes les opcions que té el YAML, veure [el següent enllaç](https://bookdown.org/yihui/rmarkdown/html-document.html)

``` {.r code-line-numbers="4,6,8"}
title: "Postgrau d'Analista de Dades (UB)"
author: "Nom de l'estudiant"
output:
  html_document:
    code_folding: hide
  pdf_document:
    toc: yes
  word_document:
```

I també podem crear [diapositives](https://quarto.org/docs/presentations/revealjs/) en diversos formats.


# 4.2. RMarkdown avançat (text) {background-color="#e8e8e8"}

## Tabsets

::: panel-tabset
### Codi

```{r echo = T, eval=F}
## Títol {.tabset}

Aquí comença una tabset.

### Tab A

Contingut de `Tab A`

### Tab B

Contingut de `Tab B`

## {-}
```

### Gràfic

```{r echo = F}
hist(dplyr::starwars$height)
```
:::




## Incloure codi al text {.scrollable}

En qualsevol moment podem fer referència al text sobre qualsevol dada **ja carregada** en un chunk previ.

-   A. Carreguem les dades:

```{r echo = T}
polity <- read_excel("p5v2018.xls")
```

-   B. Referenciem les dades al text:


::: panel-tabset

### Exemple 1

En aquest gràfic veiem Estats Units en els darrers anys

```{r echo = T, eval = T}
p5_dk <- polity |> 
  filter(country == params$country, year > 2009) |> 
  select(country, year, polity2)
knitr::kable(p5_dk)
```

Observem que en l'últim any de dades **r last(p5_dk$polity2)**, **r params$country** tenia un nivell de democràcia de **r last(p5_dk$polity2)**.


### Exemple 2

```{r echo = T}
polity |> 
  group_by(country) |> 
  summarize(duration = max(durable, na.rm = T)) |> 
  ggplot(aes(x = duration)) +
  geom_density()
```

El règim amb més durada és:

```{r eval = F, echo = T}
`polity$country[which(polity$durable == max(polity$durable, na.rm = T))]`
```


:::



## Quadres de text

::: {.callout-note icon="false"}
## Avís!

Utilitzar quadres de text és una manera efectiva per dirigir l'atenció a determinat contingut. 
:::

    <div class="alert alert-info">
    **Informació!** Blablabla.
    </div>

Tipus: 

- `primary`, `secondary`, `success`, `danger`, `warning`, `info`, `light`, `dark`.





## Incrustar vídeos i tuits

Amb `vembedr` és molt fàcil.

```{r eval = F, echo = T}
embed_url("https://youtu.be/hz3J6Wb5S_8")
```


{{< video https://youtu.be/hz3J6Wb5S_8 >}}

Encara més fàcil amb altres formats de Bookdown:

```{r eval = F, echo = T}
{{< video https://youtu.be/wo9vZccmqwc >}}
{{< tweet 1229386394658836480 >}}
```



## Referències al text

Per referenciar la secció del document[^5]:

[^5]: En aquest [enllaç](https://bookdown.org/yihui/rmarkdown-cookbook/cross-ref.html){target="_blank"}, també podeu veure com es poden referenciar taules i marcs de dades

```{r eval = F, echo = T}
# Introducció {#intro}
```


En qualsevol moment del text, introduïm:

    [text](#intro)

## Referències bibliogràfiques {.scrollable}

Ho farem normalment amb un document **BibTex** (`.bib`)[^6].

[^6]: Alguns paquets d'R com `RefManageR` automatitzen la gestió de cites.

1.  Obrim un **Text file**, el guardem com a `biblio.bib` i introduïm:

<!-- -->

    @misc{Marshall2020,
    author = {Marshall, Monty G. and Gurr, Ted Robert},
    mendeley-groups = {Ind Political},
    publisher = {Center for Systemic Peace},
    title = {{Polity V. Political Regime Characteristics and Transitions, 1800-2018}},
    year = {2020}
    }

2.  Indiquem al **YAML** on es troba l'arxiu:

<!-- -->

    bibliography: biblio.bib

3.  Citem les referències al **text**.

-   Entre claudàtors `[@Marshall2020]`, ens posarà (Marshall 2020).
-   Sense claudàtors `@Marshall2020`, ens posarà Marshall (2020).

4.  En l'última línia del document de RMarkdown, posarem un títol `# Referències` per separar la bibliografia de la resta del text.

::: aside
Per saber-ne més sobre l'estil de citació BibTex, podeu consultar [RMarkdown Cookbook: Bibliographies and Citations](https://bookdown.org/yihui/rmarkdown-cookbook/bibliography.html), [Reproducible Research in R: Section 10 Citations](https://monashdatafluency.github.io/r-rep-res/citations.html) o [Wikibooks: LaTeX/Bibliography Management](https://en.wikibooks.org/wiki/LaTeX/Bibliography_Management#BibTeX).
:::

# 4.3. RMarkdown avançat (chunks) {background-color="#e8e8e8"}

## Taules

::: panel-tabset

## Opció knitr::kable

```{r echo = F, eval = T}
polity |> 
  filter(country %in% c("Angola", "Spain", "Vietnam"),
         year == 2014) |> 
  select(country, scode, polity2, durable) |> 
  knitr::kable()
```

Arguments d'interès:

-   `col.names = c("País", "Codi", "Democràcia", "Duració")`
-   `align = c("llcc")`
-   `caption = "Títol"`

Taules de tota mena amb [KableExtra](https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html)

## Opció DT::data.table

```{r echo = T}
polity |> 
  select(country, scode, polity2, durable) |> 
  DT::datatable()
```

:::

## Figures

Varis paràmetres per establir les dimensions:

-   `fig.width`: amplada en inches.
-   `fig.height`: alçada en inches.
-   `fig.align`: "left", "right", "center".
-   `fig.dim`: primer width i després height, c(5,3)
-   `out.width`: "50%" ocuparà el 50% de l'amplada del report

## Opcions globals

Opcions per defecte als chunks de tot el document:

```{r eval = F, echo = T}
knitr::opts_chunk$set(fig.align = "center", echo = TRUE,
                      warning = FALSE, message = FALSE,
                       fig.width = 6, fig.height = 6)
```

El primer chunk també pot ser útil per carregar els paquets i objectes que necessitarem.



## Què evitar als chunks

-   La funció `download.file()`
-   Carregar bases de dades d'internet
-   Funcions que carreguen bases de dades (ex. `CEOdata`)

## Canviar mida de text

Un dels deutes pendents de RMarkdown.

```{r eval = F, echo = T}
    <style>
    body {
    font-size: 13pt;
    text-align: justify}
    </style>
```

## Taules {.scrollable}

També una assignatura pendent de RMarkdown.

```{r eval = F, echo = T}
    | Funció       | Paquet    | Descripció                                           |
    |--------------|-----------|------------------------------------------------------|
    | `filter()`   | `dplyr`   | Filtra les observacions d'un marc de dades           |
    | `separate()` | `tidyr`   | Separa els elements d'un vector en base a un criteri |
    | `read_csv()` | `readr`   | Llegeix els arxius CSV                               |
    | `ggplot()`   | `ggplot2` | Reprodueix elements gràfics                          |

```

| Funció       | Paquet    | Descripció                                           |
|--------------|-----------|------------------------------------------------------|
| `filter()`   | `dplyr`   | Filtra les observacions d'un marc de dades           |
| `separate()` | `tidyr`   | Separa els elements d'un vector en base a un criteri |
| `read_csv()` | `readr`   | Llegeix els arxius CSV                               |
| `ggplot()`   | `ggplot2` | Reprodueix elements gràfics                          |

Hi ha algunes opcions, més senzilles, per crear taules. La primera és construir-les a partir d'un marc de dades o una matriu de dades. La segona és utilitzar l'**Editor Visual** ([veure següent apartat](#rmd-visual-editor)).

### Editor visual {#rmd-visual-editor}

L'Editor Visual va sortir en una de les actualitzacions de RMarkdown del 2020 per donar resposta a usuaris que necessitaven una interfície més semblant a Word per generar documents. Per utilitzar l'Editor Visual, heu de clicar a la rodeta del document de RMarkdown i seleccionar la primera opció:

![](img/rmarkdown-visual-editor.png){width="40%"}

Amb l'editor visual veurem una interfície que ens serà molt més familiar. No obstant, recomanem utilitzar-lo només puntualment.

### Exportar i publicar {#rmd-rpubs}

Publicar un document generat amb RMarkdown a internet és molt ràpid. La forma més directa és mitjançant RPubs, encara que també es poden fer pàgines web més sofisticades, blocs o llibres.

-   [RPubs](https://rpubs.com/): RPubs és la manera més ràpida de publicar a la xarxa. A dins d'RStudio, un cop l'Html s'hagi generat en el Viewer, cliqueu a l'icona blava del Viewer (Publish -\> Publish a Document), seleccioneu RPubs i seguiu les instruccions.
-   [Bookdown](https://bookdown.org/): Permet crear llibres com el que esteu llegint.
-   [Blogdown](https://bookdown.org/yihui/blogdown/): Permet crear blocs, com per exemple: [www.jordimas.cat](www.jordimas.cat).

## Exercici 2

Agafeu el treball d'un dataset anterior i construiu un document Html, procurant d'utilitzar algunes de les funcions avançades. En particular:

-   Tauler en knitr o DT.
-   Temes i subratllats.
-   Plegar codi.
-   Mida gràfics
-   

# Què és RMarkdown? {background-color="#e8e8e8"}

## El món de l'endemà

::: columns
::: {.column width="50%"}
[Quarto](www.quarto.org) ![](img/quarto.png)
:::

::: {.column width="50%"}
[Posit](www.posit.co) ![](img/posit.png)
:::
:::

## Bibliografia principal

-   [Guia ràpida de RMarkdown a la web de RStudio.](https://rmarkdown.rstudio.com/lesson-1.html){target="_blank"}
-   [Cheatsheet RMarkdown.](https://www.rstudio.com/resources/cheatsheets/){target="_blank"}
-   [Capítol de RMarkdown al llibre *R para ciencia de datos*](https://es.r4ds.hadley.nz/r-markdown.html){target="_blank"} [@Grolemund2020].
-   [El llibre complet: *RMarkdown: The Definitive Guide*](https://bookdown.org/yihui/rmarkdown/html-document.html){target="_blank"} [@rmarkdown2018].

## Dashboards

[flexdashboard](https://pkgs.rstudio.com/flexdashboard/)
